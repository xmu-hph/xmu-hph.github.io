---
title: AI模型准备
date: 2024-02-01 16:09:00 +0800
categories: [tools, notes]
tags: [tools]     # TAG names should always be lowercase
math: true
mermaid: true
img_path: /commons/2024-02-01-数据处理/
author: hupenghui
---
# 前言
进行人工智能相关开发，在数据准备好以后我们就需要构建模型开始训练，这包含很多工作，包括：模型代码的实现，训练环境的搭建。

# 可迁移训练环境的构建
可迁移环境的实现有两种主要方式：[conda](https://docs.conda.io/projects/miniconda/en/latest/)和[docker](https://docs.docker.com/engine/install/ubuntu/)。第一种是使用conda新建一个python环境。优点是简单易用，缺点是只能在本机器上用，如果需要在其他平台上运行就会很麻烦。第二种是使用docker构建一个包含底层环境的容器，优点是docker安装在哪里，代码就能在哪里运行，缺点是占用空间稍微大一点，构建容器用的时间也稍微长一些。
## conda环境
使用conda构建python环境的代码如下所示（以下代码都是针对linux-x86平台）：
```python
#安装miniconda
mkdir -p ~/miniconda3
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda3/miniconda.sh
bash ~/miniconda3/miniconda.sh -b -u -p ~/miniconda3
rm -rf ~/miniconda3/miniconda.sh
~/miniconda3/bin/conda init bash
~/miniconda3/bin/conda init zsh
#此时重新打开命令行窗口就可以看conda的默认base环境
#配置conda为国内的阿里云源
vim ~/.condarc
#在命令行中键入英文i，切换为插入模式，输入以下内容
channels:
  - defaults
show_channel_urls: true
default_channels:
  - http://mirrors.aliyun.com/anaconda/pkgs/main
  - http://mirrors.aliyun.com/anaconda/pkgs/r
  - http://mirrors.aliyun.com/anaconda/pkgs/msys2
custom_channels:
  conda-forge: http://mirrors.aliyun.com/anaconda/cloud
  msys2: http://mirrors.aliyun.com/anaconda/cloud
  bioconda: http://mirrors.aliyun.com/anaconda/cloud
  menpo: http://mirrors.aliyun.com/anaconda/cloud
  pytorch: http://mirrors.aliyun.com/anaconda/cloud
  simpleitk: http://mirrors.aliyun.com/anaconda/cloud
#然后键盘按下esc键，推出插入模式，再按下英文输入法下的:wq即可退出
#配置pip为国内的阿里云源
vim ~/.pip/pip.conf
#键盘按下英文输入法的i，切换为插入模式，复制粘贴以下内容
[global]
index-url = http://mirrors.aliyun.com/pypi/simple/
[install]conda 
trusted-host=mirrors.aliyun.com
#然后键盘按下esc键，推出插入模式，再按下英文输入法下的:wq即可退出
#更新conda环境使得阿里云源生效
conda update --all
#新建python环境
conda create -n env_name python=version
pip install -r requirements.txt
```
## docker环境
使用docker构建镜像的命令如下所示（本部分介绍的是以别人的镜像为基础添加组件来新建镜像的）：
```python
#基镜像
FROM registryonline-hulk.sankuai.com/custom_prod/com.sankuai.data.hadoop.gpu/data-pt2.0.1-py39-nccl2.14-cuda11.7-flashatten1.0.4-c20e7d9f
#复制文件
COPY id_rsa.pub /root/.ssh/
COPY id_rsa /root/.ssh/
#赋予执行权限
RUN chmod 600 /root/.ssh/id_rsa && mkdir -p /sources
#通过pip安装包
RUN pip3 install --no-cache-dir -i https://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com  langchain==0.0.24
RUN pip3 install --no-cache-dir -i https://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com  numpy==1.19.5
RUN pip3 install --no-cache-dir -i https://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com  pyserini==0.19.0
RUN pip3 install --no-cache-dir -i https://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com  torch_geometric
RUN pip3 install --no-cache-dir -i https://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com  tqdm
RUN pip3 install --no-cache-dir -i https://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com  transformers
RUN pip3 install --no-cache-dir -i https://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com  sentence_transformers
RUN pip3 install --no-cache-dir -i https://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com  datasets
RUN pip3 install --no-cache-dir -i https://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com  faiss-gpu
#构建环境变量
ENV PYTHONPATH="~:$PYTHONPATH"
#清理不必要的文件
RUN rm -v /root/.ssh/id_rsa* && rm -rf /sources && rm -rf /root/.cache
```